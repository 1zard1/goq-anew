# Apache Kafka: Основные понятия

## **Топик (Topic)**  
Топик — это логический канал для передачи сообщений.  
- Сообщения в Kafka публикуются в **топики**.
- Топики разделяются на **партиции**.  

**Пример:**  
Для системы заказов может быть топик `orders`, где хранятся события "создание заказа", "обновление", "отмена".

---

## **Партиция (Partition)**  
Партиция — это физический раздел топика.  
- Сообщения в каждой партиции упорядочены (имеют уникальный **оффсет**).  
- Партиции позволяют масштабировать Kafka, так как данные хранятся и обрабатываются на разных брокерах.  
- Партиция — минимальная единица параллелизма.

**Особенности:**  
1. Каждое сообщение записывается в одну партицию.
2. Партиции могут быть распределены по нескольким брокерам для отказоустойчивости.

---

## **Паблишер (Producer)** и **Консьюмер (Consumer)**  

### **Паблишер (Producer):**  
Приложение, которое публикует сообщения в топики.  
- Может отправлять сообщение в конкретную партицию (используя **роутинг-ключ**) или позволять Kafka автоматически выбрать партицию.

### **Консьюмер (Consumer):**  
Приложение, которое читает сообщения из топиков.  
- Консьюмеры могут читать сообщения из нескольких партиций.  
- Порядок сообщений гарантируется только внутри одной партиции.

---

## **Консьюмер-группа (Consumer Group)**  
Консьюмер-группа — это логическое объединение нескольких консьюмеров.  
- **Особенность:** Каждая партиция передаётся только одному консьюмеру внутри группы.  
- Если у топика больше партиций, чем консьюмеров, один консьюмер обрабатывает несколько партиций.  

**Пример:**  
Если топик имеет 6 партиций, а в группе 3 консьюмеров:
- Каждый консьюмер обрабатывает 2 партиции.  
Если добавить ещё одного консьюмера, перераспределение назначений произойдёт автоматически.

---

## **Роутинг-ключ (Routing Key)**  
Роутинг-ключ используется паблишером для определения, в какую партицию отправить сообщение.  
- Если не указан, Kafka использует алгоритм распределения (например, round-robin).  
- Если указан, используется **хэширование ключа** для определения партиции.

---

## **Связи между партициями и консьюмерами**  
1. **Одна партиция → один консьюмер в группе:**  
   - Это обеспечивает строгий порядок обработки.  

2. **Одна партиция → несколько консьюмеров (разные группы):**  
   - Разные группы читают сообщения независимо.  
   - Это позволяет создавать сценарии с параллельной обработкой одних и тех же данных.  

3. **Несколько партиций → один консьюмер:**  
   - Консьюмер обрабатывает сообщения из нескольких партиций.  
   - Порядок сообщений гарантируется только в пределах одной партиции.  

---

## **Оффсет (Offset)**  
Оффсет — это уникальный номер сообщения в пределах партиции.  
- Консьюмер использует оффсет для отслеживания, какие сообщения уже обработаны.  
- Оффсеты хранятся в Kafka (в специальном топике `__consumer_offsets`) или у клиента.

**Режимы доставки:**
1. **At-most-once:**  
   - Сообщения обрабатываются максимум один раз.  
   - Оффсет обновляется до обработки сообщения.

2. **At-least-once:**  
   - Сообщения обрабатываются минимум один раз.  
   - Оффсет обновляется после обработки.  
   - Возможны повторные обработки (дублирование).

3. **Exactly-once:**  
   - Сообщения обрабатываются строго один раз.  
   - Достигается через механизмы **idempotency** и транзакции Kafka.

---

# RabbitMQ: Основные понятия

## **Топик (Topic)** в RabbitMQ  
В RabbitMQ топики работают на уровне обменников (**Exchange**).  
- Сообщения маршрутизируются на очереди через ключи маршрутизации (**Routing Key**).  
- Топики в RabbitMQ более сложны, так как предполагают гибкие шаблоны ключей (`*.order.*`, `log.#`).

---

## **Очередь (Queue)**  
Очередь — это конечный пункт доставки сообщений.  
- Сообщения из очереди может забирать один или несколько консьюмеров.

---

## **Паблишер и Консьюмер**  

### **Паблишер (Producer):**  
Публикует сообщения в обменник (Exchange).  
- Указывает **Routing Key**, чтобы определить, в какие очереди должно попасть сообщение.  

### **Консьюмер (Consumer):**  
Читает сообщения из очереди.  
- Сообщение удаляется из очереди только после подтверждения (`ACK`).

---

## **Routing Key и связи**  
1. **Одна очередь → несколько консьюмеров:**  
   - Очередь балансирует нагрузку через механизм **Round-Robin Delivery**.  

2. **Один консьюмер → несколько очередей:**  
   - Консьюмер может подписаться на несколько очередей.

---

## **Оффсет в RabbitMQ**  
В RabbitMQ оффсет фиксируется через механизм подтверждения сообщений:  
- **ACK (Manual Acknowledge):**  
   Сообщение удаляется из очереди только после успешной обработки.  

**Режимы доставки:**
1. **At-most-once:**  
   - Сообщение удаляется из очереди при получении.  

2. **At-least-once:**  
   - Сообщение удаляется только после `ACK`. Возможна повторная доставка в случае сбоя.  

3. **Exactly-once:**  
   - Реализуется на уровне приложения (например, через idempotent operations).

---



